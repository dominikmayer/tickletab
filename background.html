<html>
<head>
<script type="text/javascript">

var STORAGE = function () {
	// private functions and properties
	var KEY_PREFIX = "tickle_";
	var st = window.localStorage;
	
	var sortfn = function (a, b) {
     	     	     		     if (a.key == b.key) {
     	     	     		     	     return 0;
     	     	     		     } 
     	     	     		     if (a.key > b.key ) {
     	     	     		     	     return 1;
     	     	     		     }
     	     	     		     return -1;
     	     	     };
     	     	     
     	 // logging
     	 var log = function (txt) {
     	 	 // console.log(txt);
     	 };

	return {
		
		clear : function() {
			st.clear();
		},
		
     	     	/**
     	     	* convert object to string (JSON) and save it
     	     	*/
		setObject : function(key, value) {
			st.setItem(key, JSON.stringify(value));
		},
		
		/**
		* @return JSON obejct creates from local storage saved value  
		*/
		getObject : function(key) {
     	     	     var value = st.getItem(key);
     	     	     if (value == null) {
     	     	     	     return null;
     	     	     } else {           
     	     	     	     return JSON.parse(value);
     	     	     }
     	     	}, 
     	     	
     	     	/**
     	     	* add tickletab to storage
     	     	*
     	     	* @param key - YYYYMMDD
     	     	* @param url - tab url
     	     	* @param tabtitle - string title
     	     	*/
     	     	addTickleTab : function(key, url, tabtitle) {
     	     	     if ( key == null || key == "" ) {
     	     	     	     return "empty key param";
     	     	     }
     	     	     if ( url == null || url == "") {
     	     	     	     return "empty url param";
     	     	     }
     	     	     if ( tabtitle == null || tabtitle == "" ) {
     	     	     	     return "empty tabtitle param";
     	     	     }     	
     	     	     
     	     	     var a = this.getObject(KEY_PREFIX + key);     
     	     	     
     	     	     // log("saved value : " + a); 
     	     	     
     	     	     if ( a == null ) {
     	     	     	     // make new one 
     	     	     	     // log("make new for key: " + key); 
     	     	     	     a = [];
     	     	     	     a.push({'url' : url , 'title' : tabtitle});     		
     	     	     } else {
     	     	     	     // add to the existing one
     	     	     	     // merge if the url is the same
     	     	     	     var p = null;
     	     	     	     
     	     	     	     for(var i = 0, l = a.length; i < l; i++ ) {
     	     	     	     	     var x = a[i];
     	     	     	     	     if (x.url == url) {
     	     	     	     	     	     p = x; 
     	     	     	     	     	     break;
     	     	     	     	     }
     	     	     	     }
     	     	     	     
     	     	     	     // log("tickle for url : " + url + " = " + p); 
     	     	     	     
     	     	     	     if( p == null) {
     	     	     	     	     // append new one
     	     	     	     	     a.push({'url' : url , 'title' : tabtitle}); 
     	     	     	     } else {			
     	     	     	     	     p.title = tabtitle; 
     	     	     	     }     		
     	     	     }
     	     	     this.setObject(KEY_PREFIX + key, a);
     	       },
     	       
     	     /**
     	     * remove tickletabs
     	     *
     	     * @param key - YYYYMMDD
     	     * @param url (optional) - tab url to remove
     	     */
     	     removeTickleTabs : function(key, url) {
     	     	     if ( key == null || key == "" ) {
     	     	     	     return "empty key param";
     	     	     }
     	     	     if ( url == null || url == "") {
     	     	     	     // log("remove all tickletabs for key : " + key);
     	     	     	     st.removeItem(KEY_PREFIX + key);
     	     	     } else {
     	     	     	     // log("remove tickletabs for url : " + url);
     	     	     	     var a = this.getObject(KEY_PREFIX + key);     
     	     	     	     if (a != null) {
     	     	     	     	     var r = [];
     	     	     	     	     
     	     	     	     	     for(var i = 0, l = a.length; i < l; i++ ) {
     	     	     	     	     	     var x = a[i];
     	     	     	     	     	     if (x.url != url) {
     	     	     	     	     	     	     r.push(x); 
     	     	     	     	     	     }
     	     	     	     	     }
     	     	     	     	     a = r;
     	     	     	     }
     	     	     	     this.setObject(KEY_PREFIX + key, a);
     	     	     }
     	     }, 
     	     
     	     /**
     	     * @return array of tickletabs for key specified 
     	     */
     	     getTickleTab : function(key) {     	     
     	     	     if ( key == null || key == "" ) {
     	     	     	     return null;
     	     	     }
     	     	     
     	     	     return this.getObject(KEY_PREFIX + key); 
     	     }, 
     	     
     	     /**
     	     * @return all tickletabs from local storage
     	     */
     	     getAllTickleTabs : function() {
     	     	     var res = [];
     	     	     for(var i = 0, l = st.length; i < l; i++) {
     	     	     	     var y = st.key(i);
     	     	     	     // begin with 
     	     	     	     if (y.indexOf(KEY_PREFIX) == 0 ) {
     	     	     	     	     res.push({'key': y.substr(KEY_PREFIX.length) , 'value' : this.getObject(y)});
     	     	     	     }                                                              
     	     	     }
     	     	     
     	     	     res.sort(sortfn);
     	     	     return res;
     	     }, 

       	     /**
     	     * @return tickletabs from local storage filtered with the 
     	     */
     	     getTickleTabs : function(key) {
     	     	     var res = [];
     	     	     for(var i = 0, l = st.length; i < l; i++) {
     	     	     	     var y = st.key(i);
     	     	     	     // begin with
     	     	     	     if (y.indexOf(KEY_PREFIX) == 0 ) {
     	     	     	     	     var x = y.substr(KEY_PREFIX.length);
     	     	     	     	     // log("x = " + x);
     	     	     	     	     if ( x <= key ) {
     	     	     	     	     	     res.push({'key': x, 'value' : this.getObject(y)});     	     	     	     	     	     
     	     	     	     	     }
     	     	     	     }
     	     	     }
     	     	     
     	     	     res.sort(sortfn);
     	     	     
     	     	     return res;
     	     }
     	       
	};
}();

function getLocalStorage() {
     return STORAGE;
}
          
// TODO Der SplashScreen (hier options.html) sollte nur einmal nach Installation aufgerufen werden.
// Hierzu in LocalStorage mit Mikhail's Funktionen einen Flag abfragen bzw setzen. Siehe Bsp "Google Similar Page Extension".
chrome.tabs.create( {url : "options.html"});


function getCurrentDateTime() {
	var currentDateTime = new Date();
	
	var year = currentDateTime.getFullYear();
	var month = currentDateTime.getMonth() + 1;
	var day = currentDateTime.getDate();
	var hour = currentDateTime.getHours();
	var minute = currentDateTime.getMinutes();
	
	return year + " " + month + " " + day + " " + hour + " " + minute;
}      
     
</script>
</head>
</html>