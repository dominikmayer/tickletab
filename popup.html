<style>
body{
  min-width:357px;
  overflow-x:hidden;
  font-size:8pt;
}
table {
  min-width:357px;
  overflow-x:hidden;
  font-size:8pt;
}
td {
	vertical-align:top;
}
img {
  margin:5px;
  border:0px;
  vertical-align:middle;
}
img.ui-icon {
	left:0.2em;
	margin:-8px 5px 0 0;
	position:absolute;
	top:50%;
}

input {
	height: 19px;
	width: 70px;
	color: #000000;
	background: #ffffff;
	border: 1px solid #000000
}
input.hasDatepicker{
	background-color:transparent;
	border:1px solid transparent;
}
input.hasDatepicker:hover{
	background-color:white;
	border:1px solid #000000;
}
</style>
<link type="text/css" rel="stylesheet" href="ui-lightness/jquery-ui-1.7.2.custom.css">

<script type="text/javascript" src="lib/jquery.min.js"></script>
<script type="text/javascript" src="lib/jquery-ui.min.js"></script>

<script>
	$(function() {
			$("#datepicker").datepicker({
					dateFormat: "yymmdd",
					firstDay: 1, 
					changeFirstDay: false,
					showOtherMonths: true,
					selectOtherMonths: true,
					minDate: 0,
					onSelect : function (dateText) {
						addDateLabel(dateText);
						addTickleTab(dateText);
					}					
			});
		$("#accordion").accordion({
			autoHeight: false,
			fillSpace: true,
			event: "mouseover"
		});
		//$("#tabs").tabs({
		//	event: 'mouseover'
		//});
	});
	
	function addDateLabel(key) {
		var t = document.getElementById("new-date-label");
		
		if (t.value != '') {
			chrome.extension.getBackgroundPage().STORAGE.addDateLabel(key, t.value);
			t.value = '';
		}
	};
	
	function addTickleTab(key) {		
		chrome.tabs.getSelected(focusedWindowId, 
			function ( tab ) {
				chrome.extension.getBackgroundPage().STORAGE.addTickleTab(key, tab.url, tab.title);

				chrome.tabs.getAllInWindow(focusedWindowId,function(tabs){
						if (tabs.length == 1) {
							// open chrome://newtab to prevent chrome from closing 
							chrome.tabs.create({
									'windowId' : focusedWindowId,
									'url' : 'chrome://newtab',
									'selected' : true
							});
						}
						// close tab
						try {
							chrome.tabs.remove(tab.id);
						} catch (e) {
							alert(e);
						}
						// close self
						
						window.close();
				});				
				
			});
	};
	
	function shortenTabTitle(title) {
		if (title.length > 35) {
			title = title.substring(0,32) + '...';
		}
		
		return title;
	}
	
	var focusedWindowId = undefined;
	var currentWindowId = undefined;

	function onLoad() {
		chrome.windows.getCurrent(function(currentWindow) {
				currentWindowId = currentWindow.id;
				chrome.windows.getLastFocused(function(focusedWindow) {
						focusedWindowId = focusedWindow.id;
						// loadWindowList();
				});
		});
		updateTodayList();
		updateDateLabelsList();
		updateDashboard();
	};

//	function getCurrentDateAsKey() {
//		var d = new Date();
//		var dd = d.getDate();
//		if (dd < 10 ) {
//			dd = '0' + dd;
//		}
//		var mm = d.getMonth() + 1;
//		if (mm < 10) {
//			mm = '0' + mm;
//		}
//		return d.getFullYear() + '' + mm +'' +  dd;
//	};

	function updateTodayList() {
		var key = chrome.extension.getBackgroundPage().getCurrentDateAsKey();
		var a = chrome.extension.getBackgroundPage().STORAGE.getTickleTabs(key);
		
		var t = document.getElementById("today-list-content");
		var tt = document.getElementById("today-list-actions");
		console.log(a);
		updateList(a, t, tt, 0);

	
	};

	function updateDashboard(){
		var a = chrome.extension.getBackgroundPage().STORAGE.getAllTickleTabs();

		var t = document.getElementById("dashboard-content");
		var tt = document.getElementById("dashboard-actions");

		updateList(a, t, tt, 2);
	}

	function updateList(data, content, actions, folder){
		if (data != null && data.length > 0) {		
			// remove all child nodes 
			content.innerHTML = "";
			
			for(var i = 0, l = data.length; i < l; i++ ) {
				// key -> value :[{url, title}]
				var ai = data[i];

				var b = ai.value;
				if (b != null) {
					for(var ii = 0, ll = b.length; ii < ll; ii++ ) {
						//{url, title}
						var y = b[ii];
						var kb = ai.key;
						var tr = document.createElement('tr');
						var tdt = document.createElement('td');
						var tdi = document.createElement('td');
						var tdr = document.createElement('td');
						var ach = document.createElement('a');
						var achr = document.createElement('a');
						ach.href = 'javascript:void(0)';
						ach.onclick = bindOpenTickleTab(kb, y.url);
						var short_title = document.createTextNode(shortenTabTitle(y.title));
						ach.appendChild(short_title);
						ach.setAttribute("title", y.title);
						tdt.appendChild(ach);
						var input = document.createElement('input');
						input.setAttribute("id", 'dpt-' + String(folder) + '-' + i + '-' + ii);
						input.setAttribute('value', ai.key.substr(0,4)+'-'
							+ai.key.substr(4,2) + '-' + ai.key.substr(6,2));
						input.setAttribute("readonly", 'true');
						input.setAttribute("title", 'Click to change');
						tdi.appendChild(input);
						achr.href = 'javascript:void(0)';
						achr.onclick = bindRemoveTickleTab(kb, y.url);
						var del_icon = document.createElement('img');
						del_icon.setAttribute("src", 'images/delete.png');
						del_icon.setAttribute("alt", '(x)');
						del_icon.setAttribute("title", 'Click to delete');
						del_icon.setAttribute("width", '10px');
						del_icon.setAttribute("height", '10px');
						achr.appendChild(del_icon);
						tdr.appendChild(achr);
						tr.appendChild(tdi);
						tr.appendChild(tdt);
						tr.appendChild(tdr);
						content.appendChild(tr);
						$('#dpt-' + String(folder) + '-' + i + '-' + ii).datepicker({
							dateFormat: 'yy-mm-dd',
							//showOn: 'both',
							//buttonText: "Change",
							//buttonImage: 'images/cal.png',
							//buttonImageOnly: true,
							showOtherMonths: true,
							selectOtherMonths: true,
							minDate: 0,
							onSelect : function(dateText){changeDate(dateText, kb, y.url, y.title)}
						});
						//$('.ui-datepicker-trigger').addClass('ui-icon ui-icon-calendar');
					}
				}
			}
			if (folder == 0){
				actions.innerHTML = "<a href='javascript:openAllTickleTabs();' >" + chrome.i18n.getMessage("openAll") + "</a>";
			}
		} else {
			// hide first accordion if there are no tabs
			$("#accordion").accordion('activate', 1);
			$(".ui-accordion-header").eq(folder).hide().next().hide();
			//t.innerHTML = "no tabs for today";
			//tt.innerHTML = ""; 
		}
	}

	function changeDate(dateText, key, url, title){
			var storeDate = dateText.substr(0,4)+dateText.substr(5,2)+dateText.substr(8,2);
			chrome.extension.getBackgroundPage().STORAGE.removeTickleTabs(key, url);
			chrome.extension.getBackgroundPage().STORAGE.addTickleTab(
				storeDate, url, title);
			window.close();
	}

	function changeLabel(oldDate, newDate, title){
			var oldKey = oldDate.substr(0,4)+oldDate.substr(5,2)+oldDate.substr(8,2);
			var newKey = newDate.substr(0,4)+newDate.substr(5,2)+newDate.substr(8,2);
			chrome.extension.getBackgroundPage().STORAGE.removeDateLabels(oldKey, title);
			chrome.extension.getBackgroundPage().STORAGE.addDateLabel(newKey, title);
			updateDateLabelsList();
	}
	
	function bindOpenTickleTab(key, url) {
		return function() {
			openTickleTab(key, url);
		};
	}

	function bindAddTickleTab(key) {
		return function() {
			addTickleTab(key);
		};
	}

	function bindRemoveTickleTab(key, url) {
		return function() {
			removeTickleTab(key, url);
			$(this).parent().parent().hide();
		};
	}
	
	function openAllTickleTabs() {
		// call on click for each node
		var t = document.getElementById("today-list-content");
		var a = t.childNodes;
		for(var i = 0, l = a.length; i < l; i++ ) {
			a[i].childNodes[1].childNodes[0].onclick();
		}
	}
	
	function openTickleTab(key, url) {
		try {
			chrome.tabs.create({
					'windowId' : focusedWindowId,
					'url' : url,
					'selected' : true
			});
			
			// remove tickle tab from storage
			chrome.extension.getBackgroundPage().STORAGE.removeTickleTabs(key, url);
		} catch (e) {
			alert(e);
		}
		// close self
		// window.close();
	}
	
	function removeTickleTab(key, url) {
		try {
			// remove tickle tab from storage
			chrome.extension.getBackgroundPage().STORAGE.removeTickleTabs(key, url);
		} catch (e) {
			alert(e);
		}
	}

	function bindRemoveDateLabel(key, title) {
		return function() {
			chrome.extension.getBackgroundPage().STORAGE.removeDateLabels(key, title);
			updateDateLabelsList();
		};
	}
	
	// render date-labels component list
	function updateDateLabelsList() {
		var data = chrome.extension.getBackgroundPage().STORAGE.getDataLabels();
		var t = document.getElementById("date-labels");
		t.innerHTML = "";
		if (data != null && data.length > 0 ) {

			for(var i = 0, l = data.length; i < l; i++ ) {
				// key -> value: [label1, label 2]
				var a = data[i];
				var b = a.value;
				var datestr = a.key.substr(0,4) + '-' + a.key.substr(4,2) + '-' + a.key.substr(6,2);
				if (b != null) {
					for(var ii = 0, ll = b.length; ii < ll; ii++ ) {
						var label = b[ii]; 
						var tr = document.createElement('tr');
						var tdi = document.createElement('td');
						var tdt = document.createElement('td');
						var tdr = document.createElement('td');

						var a1 = document.createElement('a');
						a1.href = 'javascript:void(0)';
						a1.appendChild(document.createTextNode(label));
						// action binding
						a1.onclick = bindAddTickleTab(a.key);

						var input = document.createElement('input');
						input.setAttribute("id", 'dpl-' + i + '-' + ii);
						input.setAttribute('value', datestr);
						input.setAttribute("readonly", 'true');
						input.setAttribute("title", 'Click to change');
						tdi.appendChild(input);

						var a2 = document.createElement('a');
						a2.href = 'javascript:void(0)';
						var del_icon = document.createElement('img');
						del_icon.setAttribute("src", 'images/delete.png');
						del_icon.setAttribute("alt", '(x)');
						del_icon.setAttribute("title", 'Click to delete');
						del_icon.setAttribute("width", '10px');
						del_icon.setAttribute("height", '10px');
						a2.appendChild(del_icon);
						// action binding
						a2.onclick = bindRemoveDateLabel(a.key, label); 
						tdt.appendChild(a1);
						tdr.appendChild(a2);
						tr.appendChild(tdi);
						tr.appendChild(tdt);
						tr.appendChild(tdr);
						t.appendChild(tr);

						$('#dpl-' + i + '-' + ii).datepicker({
							dateFormat: 'yy-mm-dd',
							showOtherMonths: true,
							selectOtherMonths: true,
							minDate: 0,
							onSelect : function(dateText){changeLabel(datestr, dateText, label)}
						});
					}
				}
			}
		} else {
			// t.innerHTML = "";
		}
	}
	
</script>

<body onload="onLoad()">
	<div id='accordion' style='height:400px'>
		<h3><a href='#'><script type="text/javascript">document.write(chrome.i18n.getMessage("ActiveTabs"));</script></a></h3>
		<div id='today-list'>
			<table id='today-list-content'>
			</table>
			<div align="right" id='today-list-actions'>
			</div>
		</div>
		<h3><a href='#'><script type="text/javascript">document.write(chrome.i18n.getMessage("closeTabUntil"));</script></a></h3>		
		<div id='close'>
			<div>
			<table id='date-labels'>
			</table>
			<div><script type="text/javascript">document.write(chrome.i18n.getMessage("defineLabel"));</script>: <input id="new-date-label" value=''></div>
			</div>
			<div id='datepicker'></div>
		</div>
		<h3><a href='#'><script type="text/javascript">document.write(chrome.i18n.getMessage("TicklerDashboard"));</script></a></h3>
		<div id='dashboard'>
			<table id='dashboard-content'>
			</table>
		</div>
	</div>
	<!--<div id='tabs'>
		<ul>
			<li><a href="#today-list">Active tabs today</a></li>
			<li><a href="#close">Close tab until</a></li>
			<li><a href="#dashboard">Dashboard</a></li>
		</ul>
		<div id="today-list">
			<table id='today-list-content'>
			</table>
			<div align="right" id='today-list-actions'>
			</div>
		</div>
		<div id="close">
			<div>
				<ul id='date-labels'>
					<li><a href='javascript:void(0);'>GTUG (1. March 2010)</a> (<a href='javascrip:void(0)'>x</a>)</li>
					<li>Birthday (25. February 2011) (x)</li>
					<li>Define new (optional): <input id="date-label" value=''></li>
				</ul>
			<div>Define new (optional): <input id="new-date-label" value=''></div>
			</div>
			<div id='datepicker'></div>
		</div>
		<div id="dashboard">
			<table id='dashboard-content'>
			</table>
		</div>
	</div>-->
</body>
