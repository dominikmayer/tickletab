<style>
body{
  min-width:357px;
  overflow-x:hidden;
  font-size:8pt;
}
table {
  min-width:357px;
  overflow-x:hidden;
  font-size:8pt;
}
td {
	vertical-align:top;
}
img {
  margin:5px;
  border:0px;
  vertical-align:middle;
}
img.ui-icon {
	left:0.2em;
	margin:-8px 5px 0 0;
	position:absolute;
	top:50%;
}

input {
	height: 19px;
	width: 70px;
	color: #000000;
	background: #ffffff;
	border: 1px solid #000000
}
input.hasDatepicker{
	background-color:transparent;
	border:1px solid transparent;
}
input.hasDatepicker:hover{
	background-color:white;
	border:1px solid #000000;
}
</style>
<link type="text/css" rel="stylesheet" href="ui-lightness/jquery-ui-1.7.2.custom.css">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
<script>
	
	
	$(function() {
			$("#datepicker").datepicker({
					dateFormat: "yymmdd",
					firstDay: 1, 
					changeFirstDay: false,
					showOtherMonths: true,
					selectOtherMonths: true,
					minDate: 0,
					onSelect : function (dateText) {
						chrome.tabs.getSelected(focusedWindowId, 
									function ( tab) {
										chrome.extension.getBackgroundPage().STORAGE.addTickleTab(dateText, tab.url, tab.title);
										// close tab
										try {
											chrome.tabs.remove(tab.id);
										} catch (e) {
											alert(e);
										}
										// close self
										window.close();
									}
								);
					}					
			});
		$("#accordion").accordion({
			autoHeight: false,
			event: "mouseover"
		});
	});

	var focusedWindowId = undefined;
	var currentWindowId = undefined;

	function onLoad() {
		chrome.windows.getCurrent(function(currentWindow) {
				currentWindowId = currentWindow.id;
				chrome.windows.getLastFocused(function(focusedWindow) {
						focusedWindowId = focusedWindow.id;
						// loadWindowList();
				});
		});
		updateTodayList();
		updateDashboard();
	};

//	function getCurrentDateAsKey() {
//		var d = new Date();
//		var dd = d.getDate();
//		if (dd < 10 ) {
//			dd = '0' + dd;
//		}
//		var mm = d.getMonth() + 1;
//		if (mm < 10) {
//			mm = '0' + mm;
//		}
//		return d.getFullYear() + '' + mm +'' +  dd;
//	};

	function updateTodayList() {
		var key = chrome.extension.getBackgroundPage().getCurrentDateAsKey();
		var a = chrome.extension.getBackgroundPage().STORAGE.getTickleTabs(key);
		
		var t = document.getElementById("today-list-content");
		var tt = document.getElementById("today-list-actions");
		console.log(a);
		updateList(a, t, tt, 0);

	
	};

	function updateDashboard(){
		var a = chrome.extension.getBackgroundPage().STORAGE.getAllTickleTabs();

		var t = document.getElementById("dashboard-content");
		var tt = document.getElementById("dashboard-actions");

		updateList(a, t, tt, 2);
	}

	function updateList(data, content, actions, folder){
		if (data != null && data.length > 0) {		
			// remove all child nodes 
			content.innerHTML = "";
			
			for(var i = 0, l = data.length; i < l; i++ ) {
				// key -> value :[{url, title}]
				var ai = data[i];

				var b = ai.value;
				if (b != null) {
					for(var ii = 0, ll = b.length; ii < ll; ii++ ) {
						//{url, title}
						var y = b[ii];
						var kb = ai.key;
						var tr = document.createElement('tr');
						var tdt = document.createElement('td');
						var tdi = document.createElement('td');
						var ach = document.createElement('a');
						ach.href = 'javascript:void(0)';
						ach.onclick = bindOpenTickleTab(kb, y.url);
						ach.appendChild(document.createTextNode(y.title));
						tdt.appendChild(ach);
						var input = document.createElement('input');
						input.setAttribute("id", 'dpt-' + String(folder) + '-' + i + '-' + ii);
						input.setAttribute('value', ai.key.substr(0,4)+'-'
							+ai.key.substr(4,2) + '-' + ai.key.substr(6,2));
						input.setAttribute("readonly", 'true');
						input.setAttribute("title", 'Click to change');
						tdi.appendChild(input);
						tr.appendChild(tdi);
						tr.appendChild(tdt);
						content.appendChild(tr);
						$('#dpt-' + String(folder) + '-' + i + '-' + ii).datepicker({
							dateFormat: 'yy-mm-dd',
							//showOn: 'both',
							//buttonText: "Change",
							//buttonImage: 'images/cal.png',
							//buttonImageOnly: true,
							showOtherMonths: true,
							selectOtherMonths: true,
							minDate: 0,
							onSelect : function(dateText){changeDate(dateText, kb, y.url, y.title)}
						});
						//$('.ui-datepicker-trigger').addClass('ui-icon ui-icon-calendar');
					}
				}
			}
			if (folder == 0){
				actions.innerHTML = "<a href='javascript:openAllTickleTabs();' >Open All</a>";
			}
		} else {
			// hide first accordion if there are no tabs
			$("#accordion").accordion('activate', 1);
			$(".ui-accordion-header").eq(folder).hide().next().hide();
			//t.innerHTML = "no tabs for today";
			//tt.innerHTML = ""; 
		}
	}

	function changeDate(dateText, key, url, title){
			var storeDate = dateText.substr(0,4)+dateText.substr(5,2)+dateText.substr(8,2);
			chrome.extension.getBackgroundPage().STORAGE.removeTickleTabs(key, url);
			chrome.extension.getBackgroundPage().STORAGE.addTickleTab(
				storeDate, url, title);
			window.close();
	}
	
	function bindOpenTickleTab(key, url) {
		return function() {
			openTickleTab(key, url);
		};
	}
	
	function openAllTickleTabs() {
		// call on click for each node
		var t = document.getElementById("today-list-content");
		var a = t.childNodes;
		for(var i = 0, l = a.length; i < l; i++ ) {
			a[i].childNodes[1].childNodes[0].onclick();
		}
	}
	
	function openTickleTab(key, url) {
		try {
			chrome.tabs.create({
					'windowId' : focusedWindowId,
					'url' : url,
					'selected' : true
			});
			
			// remove tickle tab from storage
			chrome.extension.getBackgroundPage().STORAGE.removeTickleTabs(key, url);
		} catch (e) {
			alert(e);
		}
		// close self
		// window.close();
	}
	
</script>

<body onload="onLoad()">
	<div id='accordion'>
		<h3><a href='#'>Active Tabs today</a></h3>
		<div id='today-list'>
			<table id='today-list-content'>
			</table>
			<div align="right" id='today-list-actions'>
			</div>
		</div>
		<h3><a href='#'>Close tab and show on</a></h3>
		<div id='close'>
			<ul>
				<li>GTUG (1. March 2010) (x)</li>
				<li>Birthday (25. February 2011) (x)</li>
				<li>Define new (optional): <input id="date-label" value=''></li>
			</ul>
			<div id='datepicker'></div>
		</div>
		<h3><a href='#'>Tickler Dashboard</a></h3>
		<div id='dashboard'>
			<table id='dashboard-content'>
			</table>
		</div>
	</div>
</body>
